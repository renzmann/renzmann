#!/usr/bin/env bash
_funcsync() {
	# Stop ignoring anything that's been removed since the last
	# call to `funced`
	local current_ignores=$(cat $HOME/.gitignore | grep '!.local/bin/*' | awk -F '/' '{ print $3 }' | tr '\n' ' ')
	for f in $current_ignores; do
		if [[ ! -f $HOME/.local/bin/$f ]]; then
			local to_remove='!.local\/bin\/'"$f"
			sed -i /$to_remove/d $HOME/.gitignore
		fi
	done
}

_funcsave() {
	# Add the most recently edited function to version control
	local ignore_str='!.local/bin/'"$1"
	[[ -z $(cat $HOME/.gitignore | grep -x ${ignore_str}) ]] \
		&& echo ${ignore_str} >> $HOME/.gitignore \
		&& chmod u+x "$HOME/.local/bin/$1" \
		&& _funcsync
}

funcrm() {
	rm "$HOME/.local/bin/$1" && _funcsync
}

funced() {
	local funcname=$(basename $1)
	local fp=$HOME/.local/bin/${funcname}
	local template="#!/usr/bin/env bash\n${funcname}()\n{	\n}\n"
	[[ ! -f $fp ]] && cat > $fp << EOF
#!/usr/bin/env bash
${funcname}() {
	echo hello
}
EOF
	$EDITOR +2 $fp && _funcsave $funcname
}

_funced() {
	local cur=${COMP_WORDS[COMP_CWORD]}
	local funcs=$(cat $HOME/.gitignore | grep '!.local/bin/*' | awk -F '/' ' { print $3 }')
	COMPREPLY=( $(compgen -W "$funcs" -- $cur) )
}

complete -F _funced funced
complete -F _funced funcrm
